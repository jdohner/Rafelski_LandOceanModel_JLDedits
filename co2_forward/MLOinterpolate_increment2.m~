% 3/13/08: changed CO2 dataset to spline fit with sigma =0.6 to capture
% 1940s plateau
% 4/2/08: changed CO2 dataset to updated ice core data, sigma=0.6
% 4/24/08: add in an option to decrease ice core data by 2 ppm; change to
% linear interpolation for this option
% 1/10/11: add updated CO2 dataset through 2010

function [annincMLOSPO,dpCO2a,year,dt,MLOSPOiceinterp_2011] = MLOinterpolate_increment2(ts,start_year,end_year)

dt = 1/ts;
    
%% processing data for co2 up to 2011 (in keeping with LR original code)
% loads in mlospo_meure (4427x2)
% starts 1640
% ends Feb 2010
% roughly monthly increments, but not perfectly. interpolate later
load co2_2011_2.mat

% years0 = mlospo_meure(:,1); % kind of unnecessary to copy over
% CO2_2011 = mlospo_meure(:,2);

% Create time array for co2_2011
year_2011 = mlospo_meure(1,1):1/ts:mlospo_meure(end,1);

% Do interpolation
% force to be exactly monthly resolution
co2_2011 = interp1(mlospo_meure(:,1),mlospo_meure(:,2),year_2011,'spline');

MLOSPOiceinterp_2011(:,1) = year_2011; % at monthly resolution
MLOSPOiceinterp_2011(:,2) = co2_2011;

%% everything past where co2_2011 ends

year_full = start_year:1/ts:end_year; 
% starts at year 1 (?) incremented by year
CO2_2016 = csvread('mergedCO2_2016.csv');
CO2_2016mo(:,1) = year_full;
CO2_2016mo(:,2) = (interp1(CO2_2016(:,1),CO2_2016(:,2),year_full)).';

% shorten to past end of co2_2011
%i1 = find(floor(100*dtdelpCO2a(:,1)) == floor(100*(start_year+(1/24))));
%i = find(CO2_2016mo(:,1) == floor(years_2011(length(years_2011)))); %2.010124963333333e3
%i = find(floor(100*CO2_2016mo(:,1)) == floor(100*(year_2011(length(year_2011))))); %2.010124963333333e3
i = find(floor(100*(start_year+(1/24))) == floor(100*MLOSPOiceinterp_2011(end,1)));

co2_combine(:,1) = year_full; 
co2_combine(:,2) = [MLOSPOiceinterp_2011(:,2) CO2_2016mo(i:length(CO2_2016mo),2)];


%% Calculate CO2 increment with monthly resolution, in ppm/year
% n = 7 is 7/1958, last value is 7/2005

for n = ((ts/2)+1):(length(year_2011)-(ts/2))
    annincMLOSPO(n,1) = MLOSPOiceinterp_2011(n,1);
    annincMLOSPO(n,2) = MLOSPOiceinterp_2011(n+(ts/2),2) - MLOSPOiceinterp_2011(n-(ts/2),2);
end

year = start_year:dt:end_year;

%% Calculate change in atmospheric concentration
% dpcCO2a = change in atmospheric co2 from preindustrial
i = find(floor(100*MLOSPOiceinterp_2011(:,1)) == floor(100*(start_year+(1/24))));
dpCO2a(:,1) = MLOSPOiceinterp_2011(i:length(MLOSPOiceinterp_2011),1); 
dpCO2a(:,2) = MLOSPOiceinterp_2011(i:length(MLOSPOiceinterp_2011),2)-MLOSPOiceinterp_2011(i,2);
